{"version":3,"file":"scene-graph-spec.js","sourceRoot":"","sources":["../../../src/test/features/scene-graph-spec.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2020 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Mesh, MeshStandardMaterial} from 'three';\n\nimport {IS_IE11} from '../../constants.js';\nimport {SceneGraphInterface, SceneGraphMixin} from '../../features/scene-graph.js';\nimport ModelViewerElementBase, {$scene} from '../../model-viewer-base.js';\nimport {ModelScene} from '../../three-components/ModelScene.js';\nimport {assetPath, rafPasses, waitForEvent} from '../helpers.js';\nimport {BasicSpecTemplate} from '../templates.js';\n\nconst expect = chai.expect;\n\nconst ASTRONAUT_GLB_PATH = assetPath('models/Astronaut.glb');\n\nsuite('ModelViewerElementBase with SceneGraphMixin', () => {\n  if (IS_IE11) {\n    // TODO(#999): Unskip this suite when we support IE11 in 3DOM\n    console.warn('Skipping this suite for IE11 only');\n    return;\n  }\n\n  let nextId = 0;\n  let tagName: string;\n  let ModelViewerElement:\n      Constructor<ModelViewerElementBase&SceneGraphInterface>;\n  let element: InstanceType<typeof ModelViewerElement>;\n\n  setup(() => {\n    tagName = `model-viewer-scene-graph-${nextId++}`;\n    ModelViewerElement = class extends SceneGraphMixin\n    (ModelViewerElementBase) {\n      static get is() {\n        return tagName;\n      }\n    };\n    customElements.define(tagName, ModelViewerElement);\n\n    element = new ModelViewerElement();\n    document.body.appendChild(element);\n  });\n\n  teardown(() => {\n    const {worklet} = element;\n\n    if (worklet != null) {\n      worklet.terminate();\n    }\n\n    document.body.removeChild(element);\n  });\n\n  BasicSpecTemplate(() => ModelViewerElement, () => tagName);\n\n  suite('without a scene graph worklet script', () => {\n    suite('with a loaded model', () => {\n      setup(async () => {\n        element.src = ASTRONAUT_GLB_PATH;\n\n        await waitForEvent(element, 'load');\n        await rafPasses();\n      });\n\n      test('does not activate a scene graph worklet', () => {\n        expect(element.worklet).to.not.be.ok;\n      });\n    });\n  });\n\n  suite('with a scene graph worklet script', () => {\n    test('eventually creates a new worklet', async () => {\n      const script = document.createElement('script');\n      script.type = 'experimental-scene-graph-worklet';\n      script.textContent = 'console.log(\"Hello, worklet!\");';\n\n      element.appendChild(script);\n\n      await waitForEvent(element, 'worklet-created');\n\n      expect(element.worklet).to.be.ok;\n    });\n\n    suite('with a loaded model', () => {\n      setup(async () => {\n        element.src = ASTRONAUT_GLB_PATH;\n\n        await waitForEvent(element, 'load');\n        await rafPasses();\n      });\n\n      test('allows the scene graph to be manipulated', async () => {\n        const scene = element[$scene] as ModelScene;\n\n        const script = document.createElement('script');\n\n        script.type = 'experimental-scene-graph-worklet';\n        script.setAttribute('allow', 'material-properties; messaging');\n        script.textContent = `\nself.addEventListener('model-change', function() {\n  model.materials[0].pbrMetallicRoughness.setBaseColorFactor([1, 0, 0, 1]).then(function() {\n    self.postMessage('done');\n  });\n});\n`;\n\n        element.appendChild(script);\n\n        await waitForEvent(element, 'worklet-created');\n\n        await waitForEvent(element.worklet!, 'message');\n\n        expect(((scene.children[0]\n                     .children[0]\n                     .children[0]\n                     .children[0]\n                     .children[0] as Mesh)\n                    .material as MeshStandardMaterial)\n                   .color)\n            .to.include({r: 1, g: 0, b: 0});\n      });\n    });\n  });\n});\n"]}