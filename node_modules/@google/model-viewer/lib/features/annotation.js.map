{"version":3,"file":"annotation.js","sourceRoot":"","sources":["../../src/features/annotation.ts"],"names":[],"mappings":"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","sourcesContent":["\n/* @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Matrix4, Raycaster, Vector2} from 'three';\nimport {CSS2DRenderer} from 'three/examples/jsm/renderers/CSS2DRenderer.js';\n\nimport ModelViewerElementBase, {$onResize, $scene, $tick, toVector3D, Vector3D} from '../model-viewer-base.js';\nimport {Constructor} from '../utilities.js';\n\nimport {Hotspot, HotspotConfiguration} from './annotation/hotspot.js';\n\nconst $annotationRenderer = Symbol('annotationRenderer');\nconst $updateHotspots = Symbol('updateHotspots');\nconst $hotspotMap = Symbol('hotspotMap');\nconst $mutationCallback = Symbol('mutationCallback');\nconst $observer = Symbol('observer');\nconst $pixelPosition = Symbol('pixelPosition')\nconst $addHotspot = Symbol('addHotspot');\nconst $removeHotspot = Symbol('removeHotspot');\n\nconst raycaster = new Raycaster();\n\nexport declare interface AnnotationInterface {\n  updateHotspot(config: HotspotConfiguration): void;\n  positionAndNormalFromPoint(pixelX: number, pixelY: number):\n      {position: Vector3D, normal: Vector3D}|null\n}\n\n/**\n * AnnotationMixin implements a declarative API to add hotspots and annotations.\n * Child elements of the <model-viewer> element that have a slot name that\n * begins with \"hotspot\" and data-position and data-normal attributes in\n * the format of the camera-target attribute will be added to the scene and\n * track the specified model coordinates.\n */\nexport const AnnotationMixin = <T extends Constructor<ModelViewerElementBase>>(\n    ModelViewerElement: T): Constructor<AnnotationInterface>&T => {\n  class AnnotationModelViewerElement extends ModelViewerElement {\n    private[$annotationRenderer] = new CSS2DRenderer();\n    private[$hotspotMap] = new Map<string, Hotspot>();\n    private[$mutationCallback] = (mutations: Array<unknown>) => {\n      mutations.forEach((mutation) => {\n        // NOTE: Be wary that in ShadyDOM cases, the MutationRecord\n        // only has addedNodes and removedNodes (and no other details).\n        if (!(mutation instanceof MutationRecord) ||\n            mutation.type === 'childList') {\n          (mutation as MutationRecord).addedNodes.forEach((node) => {\n            this[$addHotspot](node);\n          });\n          (mutation as MutationRecord).removedNodes.forEach((node) => {\n            this[$removeHotspot](node);\n          });\n        }\n      });\n    };\n    private[$observer] = new MutationObserver(this[$mutationCallback]);\n\n    private[$pixelPosition] = new Vector2();\n\n    constructor(...args: Array<any>) {\n      super(...args);\n\n      const {domElement} = this[$annotationRenderer];\n      domElement.classList.add('annotation-container');\n      this.shadowRoot!.querySelector('.container')!.appendChild(domElement);\n    }\n\n    connectedCallback() {\n      super.connectedCallback();\n\n      for (let i = 0; i < this.children.length; ++i) {\n        this[$addHotspot](this.children[i]);\n      }\n\n      const {ShadyDOM} = self as any;\n\n      if (ShadyDOM == null) {\n        this[$observer].observe(this, {childList: true});\n      } else {\n        this[$observer] =\n            ShadyDOM.observeChildren(this, this[$mutationCallback]);\n      }\n    }\n\n    disconnectedCallback() {\n      super.disconnectedCallback();\n\n      const {ShadyDOM} = self as any;\n\n      if (ShadyDOM == null) {\n        this[$observer].disconnect();\n      } else {\n        ShadyDOM.unobserveChildren(this[$observer]);\n      }\n    }\n\n    /**\n     * Since the data-position and data-normal attributes are not observed, use\n     * this method to move a hotspot. Keep in mind that all hotspots with the\n     * same slot name use a single location and the first definition takes\n     * precedence, until updated with this method.\n     */\n    updateHotspot(config: HotspotConfiguration) {\n      const hotspot = this[$hotspotMap].get(config.name);\n\n      if (hotspot == null) {\n        return;\n      }\n\n      hotspot.updatePosition(config.position);\n      hotspot.updateNormal(config.normal);\n    }\n\n    /**\n     * This method returns the world position and normal of the point on the\n     * mesh corresponding to the input pixel coordinates given relative to the\n     * model-viewer element. The position and normal are returned as strings in\n     * the format suitable for putting in a hotspot's data-position and\n     * data-normal attributes. If the mesh is not hit, position returns the\n     * empty string.\n     */\n    positionAndNormalFromPoint(pixelX: number, pixelY: number):\n        {position: Vector3D, normal: Vector3D}|null {\n      const {width, height} = this[$scene];\n      this[$pixelPosition]\n          .set(pixelX / width, pixelY / height)\n          .multiplyScalar(2)\n          .subScalar(1);\n      this[$pixelPosition].y *= -1;\n      raycaster.setFromCamera(this[$pixelPosition], this[$scene].getCamera());\n      const hits = raycaster.intersectObject(this[$scene], true);\n\n      if (hits.length === 0) {\n        return null;\n      }\n\n      const hit = hits[0];\n      if (hit.face == null) {\n        return null;\n      }\n\n      const worldToPivot =\n          new Matrix4().getInverse(this[$scene].pivot.matrixWorld);\n      const position = toVector3D(hit.point.applyMatrix4(worldToPivot));\n      const normal =\n          toVector3D(hit.face.normal.applyMatrix4(hit.object.matrixWorld)\n                         .applyMatrix4(worldToPivot));\n      return {position: position, normal: normal};\n    }\n\n    [$tick](time: number, delta: number) {\n      super[$tick](time, delta);\n      this[$updateHotspots]();\n      this[$annotationRenderer].render(this[$scene], this[$scene].activeCamera);\n    }\n\n    [$onResize](e: {width: number, height: number}) {\n      super[$onResize](e);\n      this[$annotationRenderer].setSize(e.width, e.height);\n    }\n\n    [$updateHotspots]() {\n      const {children} = this[$scene].pivot;\n      for (let i = 0, l = children.length; i < l; i++) {\n        const hotspot = children[i];\n        if (hotspot instanceof Hotspot) {\n          const view = this[$scene].activeCamera.position.clone();\n          view.sub(hotspot.position);\n          const normalWorld = hotspot.normal.clone().transformDirection(\n              this[$scene].pivot.matrixWorld);\n          if (view.dot(normalWorld) < 0) {\n            hotspot.hide();\n          } else {\n            hotspot.show();\n          }\n        }\n      }\n    }\n\n    [$addHotspot](node: Node) {\n      if (!(node instanceof HTMLElement &&\n            node.slot.indexOf('hotspot') === 0)) {\n        return;\n      }\n\n      let hotspot = this[$hotspotMap].get(node.slot);\n\n      if (hotspot != null) {\n        hotspot.increment();\n      } else {\n        hotspot = new Hotspot({\n          name: node.slot,\n          position: node.dataset.position,\n          normal: node.dataset.normal,\n        });\n        this[$hotspotMap].set(node.slot, hotspot);\n        this[$scene].pivot.add(hotspot);\n      }\n    }\n\n    [$removeHotspot](node: Node) {\n      if (!(node instanceof HTMLElement)) {\n        return;\n      }\n\n      const hotspot = this[$hotspotMap].get(node.slot);\n\n      if (!hotspot) {\n        return;\n      }\n\n      if (hotspot.decrement()) {\n        this[$scene].pivot.remove(hotspot);\n        this[$hotspotMap].delete(node.slot);\n        hotspot.dispose();\n      }\n    }\n  }\n\n  return AnnotationModelViewerElement;\n};\n"]}