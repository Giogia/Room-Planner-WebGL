{"version":3,"file":"ARRenderer.js","sourceRoot":"","sources":["../../src/three-components/ARRenderer.ts"],"names":[],"mappings":"AAAA;;;;;;;;;;;;;GAaG;;AAEH,OAAO,EAAC,eAAe,EAAE,OAAO,EAAE,QAAQ,EAAE,iBAAiB,EAAa,KAAK,EAAE,OAAO,GAAiB,MAAM,OAAO,CAAC;AAEvH,OAAO,EAAC,mBAAmB,EAAC,MAAM,iBAAiB,CAAC;AAIpD,OAAO,OAAO,MAAM,cAAc,CAAC;AACnC,OAAO,EAAC,aAAa,EAAC,MAAM,iBAAiB,CAAC;AAE9C,MAAM,eAAe,GAAG,MAAM,CAAC,gBAAgB,CAAC,CAAC;AAEjD,MAAM,MAAM,GAAG,MAAM,CAAC,OAAO,CAAC,CAAC;AAC/B,MAAM,eAAe,GAAG,MAAM,CAAC,gBAAgB,CAAC,CAAC;AACjD,MAAM,KAAK,GAAG,MAAM,CAAC,MAAM,CAAC,CAAC;AAC7B,MAAM,SAAS,GAAG,MAAM,CAAC,UAAU,CAAC,CAAC;AACrC,MAAM,eAAe,GAAG,MAAM,CAAC,gBAAgB,CAAC,CAAC;AACjD,MAAM,eAAe,GAAG,MAAM,CAAC,gBAAgB,CAAC,CAAC;AAEjD,MAAM,cAAc,GAAG,MAAM,CAAC,eAAe,CAAC,CAAC;AAE/C,MAAM,aAAa,GAAG,MAAM,CAAC,cAAc,CAAC,CAAC;AAC7C,MAAM,mBAAmB,GAAG,MAAM,CAAC,oBAAoB,CAAC,CAAC;AAEzD,MAAM,OAAO,GAAG,IAAI,OAAO,EAAE,CAAC;AAC9B,MAAM,OAAO,GAAG,IAAI,OAAO,EAAE,CAAC;AAE9B,MAAM,OAAO,UAAW,SAAQ,eAAe;IAkB7C,YAAoB,QAAkB;QACpC,KAAK,EAAE,CAAC;QADU,aAAQ,GAAR,QAAQ,CAAU;QAd/B,WAAM,GAAsB,IAAI,iBAAiB,EAAE,CAAC;QACpD,UAAK,GAAU,IAAI,KAAK,EAAE,CAAC;QAC3B,UAAK,GAAa,IAAI,QAAQ,EAAE,CAAC;QACjC,YAAO,GAAY,IAAI,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAC5C,cAAS,GAAmB,IAAI,CAAC;QAEjC,QAAgB,GAA+B,IAAI,CAAC;QACpD,QAAQ,GAAgB,IAAI,CAAC;QAC7B,QAAiB,GAAmB,IAAI,CAAC;QACzC,QAAW,GAA0B,IAAI,CAAC;QAC1C,QAAiB,GAA0B,IAAI,CAAC;QAChD,QAAiB,GAAoB,IAAI,CAAC;QAC1C,QAAiB,GAAoC,IAAI,CAAC;QAI/D,IAAI,CAAC,aAAa,GAAG,QAAQ,CAAC,aAAa,CAAC;QAC5C,IAAI,CAAC,YAAY,GAAG,QAAQ,CAAC,SAAU,CAAC;QAExC,IAAI,CAAC,MAAM,CAAC,gBAAgB,GAAG,KAAK,CAAC;QAErC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC7B,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IAC7B,CAAC;IAED,kBAAkB;QAChB,IAAI,CAAC,aAAa,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC;IACtC,CAAC;IAED,KAAK,CAAC,gBAAgB;QACpB,mBAAmB,EAAE,CAAC;QAEtB,MAAM,OAAO,GAAc,MAAM,SAAS,CAAC,EAAG,CAAC,cAAe,CAC1D,cAAc,EAAE,EAAC,gBAAgB,EAAE,CAAC,UAAU,CAAC,EAAC,CAAC,CAAC;QAEtD,MAAM,EAAE,GACJ,aAAa,CAAC,IAAI,CAAC,aAAa,CAAC,UAAU,EAAE,CAAC,CAAC;QAEnD,0EAA0E;QAC1E,uEAAuE;QACvE,0EAA0E;QAC1E,MAAM,EAAE,CAAC,gBAAgB,EAAE,CAAC;QAC5B,IAAI,CAAC,cAAc,CAAC,GAAG,EAAE,CAAC;QAE1B,OAAO,CAAC,iBAAiB,CACrB,EAAC,SAAS,EAAE,IAAI,YAAY,CAAC,OAAO,EAAE,EAAE,EAAE,EAAC,KAAK,EAAE,IAAI,EAAC,CAAC,EAAC,CAAC,CAAC;QAE/D,yEAAyE;QACzE,uCAAuC;QACvC,IAAI,qBAAqB,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,OAAO,EAAE,EAAE;YAC3D,OAAO,CAAC,qBAAqB,CAAC,GAAG,EAAE,CAAC,OAAO,EAAE,CAAC,CAAC;QACjD,CAAC,CAAC,CAAC;QACH,MAAM,qBAAqB,CAAC;QAE5B,yDAAyD;QACzD,sEAAsE;QACrE,IAAI,CAAC,aAAqB;aACtB,cAAc,CAAC,OAAO,CAAC,WAAW,CAAC,SAAU,CAAC,WAAW,CAAC,CAAC;QAChE,IAAI,CAAC,aAAa,CAAC,OAAO,CACtB,OAAO,CAAC,WAAW,CAAC,SAAU,CAAC,gBAAgB,EAC/C,OAAO,CAAC,WAAW,CAAC,SAAU,CAAC,iBAAiB,EAChD,KAAK,CAAC,CAAC;QAEX,OAAO,OAAO,CAAC;IACjB,CAAC;IAED;;OAEG;IACH,IAAI,cAAc;QAChB,OAAO,IAAI,CAAC,eAAe,CAAC,CAAC;IAC/B,CAAC;IAED;;;OAGG;IACH,KAAK,CAAC,oBAAoB;QACxB,IAAI;YACF,mBAAmB,EAAE,CAAC;YACtB,OAAO,MAAM,SAAS,CAAC,EAAG,CAAC,kBAAkB,CAAC,cAAc,CAAC,CAAC;SAC/D;QAAC,OAAO,KAAK,EAAE;YACd,OAAO,KAAK,CAAC;SACd;IACH,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,OAAO,CAAC,KAAiB;QAC7B,IAAI,IAAI,CAAC,YAAY,EAAE;YACrB,OAAO,CAAC,IAAI,CAAC,oDAAoD,CAAC,CAAC;SACpE;QAED,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,CAAC;QAE/B,IAAI,CAAC,eAAe,CAAC,GAAG,KAAK,CAAC;QAE9B,IAAI,CAAC,kBAAkB,EAAE,CAAC;QAE1B,IAAI,CAAC,eAAe,CAAC,GAAG,MAAM,IAAI,CAAC,gBAAgB,EAAE,CAAC;QACtD,IAAI,CAAC,eAAe,CAAE,CAAC,gBAAgB,CAAC,KAAK,EAAE,GAAG,EAAE;YAClD,IAAI,CAAC,mBAAmB,CAAC,EAAE,CAAC;QAC9B,CAAC,EAAE,EAAC,IAAI,EAAE,IAAI,EAAC,CAAC,CAAC;QAEjB,IAAI,CAAC,SAAS,CAAC;YACX,MAAM,IAAI,CAAC,eAAe,CAAE,CAAC,qBAAqB,CAAC,OAAO,CAAC,CAAC;QAChE,IAAI,CAAC,eAAe,CAAC;YACjB,MAAM,IAAI,CAAC,eAAe,CAAE,CAAC,qBAAqB,CAAC,QAAQ,CAAC,CAAC;QAEjE,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;IAChB,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,cAAc;QAClB,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE;YACtB,OAAO;SACR;QAED,MAAM,cAAc,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,EAAE;YAC7C,IAAI,CAAC,eAAe,CAAC,GAAG,OAAO,CAAC;QAClC,CAAC,CAAC,CAAC;QAEH,IAAI;YACF,MAAM,OAAO,GAAG,IAAI,CAAC,eAAe,CAAE,CAAC;YACvC,IAAI,CAAC,eAAe,CAAC,GAAG,IAAI,CAAC;YAC7B,OAAO,CAAC,oBAAoB,CAAC,IAAI,CAAC,MAAM,CAAE,CAAC,CAAC;YAE5C,MAAM,OAAO,CAAC,GAAG,EAAE,CAAC;YACpB,MAAM,cAAc,CAAC;SACtB;QAAC,OAAO,KAAK,EAAE;YACd,OAAO,CAAC,IAAI,CAAC,sCAAsC,CAAC,CAAC;YACrD,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YAEpB,IAAI,CAAC,mBAAmB,CAAC,EAAE,CAAC;SAC7B;IACH,CAAC;IAED,OAtIQ,cAAc,OACd,MAAM,OACN,eAAe,OACf,SAAS,OACT,eAAe,OACf,eAAe,OACf,eAAe,EAgItB,mBAAmB,EAAC;QACnB,yDAAyD;QACzD,qDAAqD;QACrD,sEAAsE;QACrE,IAAI,CAAC,aAAqB,CAAC,cAAc,CAAC,IAAI,CAAC,CAAC;QAEjD,gEAAgE;QAChE,4BAA4B;QAC5B,IAAI,IAAI,CAAC,eAAe,CAAC,IAAI,IAAI,EAAE;YACjC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,eAAe,CAAE,CAAC,CAAC;YAC1C,IAAI,CAAC,eAAe,CAAE,CAAC,OAAO,GAAG,IAAI,CAAC;SACvC;QACD,qDAAqD;QACrD,iEAAiE;QACjE,gEAAgE;QAChE,cAAc;QACd,IAAI,CAAC,QAAQ,CAAC,eAAe,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;QAEpC,IAAI,CAAC,SAAS,CAAC,GAAG,IAAI,CAAC;QACvB,IAAI,CAAC,eAAe,CAAC,GAAG,IAAI,CAAC;QAC7B,IAAI,CAAC,KAAK,CAAC,WAAW,GAAG,IAAI,CAAC;QAE9B,IAAI,IAAI,CAAC,eAAe,CAAC,IAAI,IAAI,EAAE;YACjC,IAAI,CAAC,eAAe,CAAE,EAAE,CAAC;SAC1B;IACH,CAAC;IAED;;OAEG;IACH,IAAI,YAAY;QACd,OAAO,IAAI,CAAC,eAAe,CAAC,IAAI,IAAI,CAAC;IACvC,CAAC;IAED,IAAI,aAAa;QACf,OAAO,IAAI,CAAC,cAAc,CAAC,CAAC;IAC9B,CAAC;IAED,KAAK,CAAC,UAAU;QACd,IAAI,IAAI,CAAC,eAAe,CAAC,IAAI,IAAI,EAAE;YACjC,OAAO;SACR;QACD,mEAAmE;QACnE,sDAAsD;QAEtD,2DAA2D;QAC3D,IAAI,IAAI,CAAC,OAAO,IAAI,IAAI,CAAC,OAAO,CAAC,SAAS,EAAE;YAC1C,MAAM,cAAc,GAAG,IAAI,CAAC,eAAe,CAAE,CAAC;YAC9C,MAAM,SAAS,GAAG,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC;YAEzC,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,qBAAqB,CAAC,SAAS,CAAC,CAAC;YAErD,4CAA4C;YAC5C,MAAM,WAAW,GAAG,OAAO,CAAC,qBAAqB,CAAC,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;YACtE,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC,EAAE,IAAI,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,EAAE,WAAW,CAAC,CAAC,CAAC,CAAC;YACvE,IAAI,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,cAAc,CAAC,KAAK,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC;YAErD,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,cAAc,CAAC,CAAC;YAE/B,IAAI,CAAC,aAAa,CAAC,EAAC,IAAI,EAAE,WAAW,EAAC,CAAC,CAAC;SACzC;IACH,CAAC;IAED;;;;;;;;OAQG;IACH,cAAc,CAAC,KAAc;QAC3B,MAAM,EAAC,OAAO,EAAC,GAAG,KAAK,CAAC;QAExB,wEAAwE;QACxE,wEAAwE;QACxE,wEAAwE;QACxE,4EAA4E;QAC5E,MAAM,OAAO,GAAG,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC;aAC3B,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,aAAa,KAAK,QAAQ,CAAC,CAAC;QAEvE,IAAI,OAAO,CAAC,MAAM,KAAK,CAAC,EAAE;YACxB,OAAO;SACR;QAED,MAAM,IAAI,GAAG,KAAK,CAAC,OAAO,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,cAAc,EAAE,IAAI,CAAC,SAAS,CAAE,CAAC,CAAC;QACxE,IAAI,IAAI,EAAE;YACR,IAAI,CAAC,UAAU,EAAE,CAAC;SACnB;IACH,CAAC;IAED,CAAC,KAAK,CAAC;QACL,IAAI,CAAC,MAAM,CAAC,GAAG,IAAI,CAAC,eAAe,CAAE,CAAC,qBAAqB,CACvD,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC,CAAC;IACzD,CAAC;IAED,CAAC,aAAa,CAAC,CAAC,KAAa,EAAE,KAAc;QAC3C,MAAM,EAAC,OAAO,EAAC,GAAG,KAAK,CAAC;QAExB,MAAM,IAAI,GAAG,KAAK,CAAC,aAAa,CAAC,IAAI,CAAC,SAAS,CAAE,CAAC,CAAC;QAEnD,0CAA0C;QAC1C,8CAA8C;QAE9C,IAAI,CAAC,KAAK,CAAC,EAAE,CAAC;QAEd,IAAI,IAAI,IAAI,IAAI,EAAE;YAChB,OAAO;SACR;QAED,IAAI,IAAI,CAAC,KAAK,CAAC,WAAW,KAAK,IAAI,CAAC,eAAe,CAAE,CAAC,WAAW,EAAE;YACjE,IAAI,CAAC,KAAK,CAAC,WAAW,GAAG,IAAI,CAAC,eAAe,CAAE,CAAC,WAAW,CAAC;SAC7D;QAED,KAAK,MAAM,IAAI,IAAI,KAAK,CAAC,aAAa,CAAC,IAAI,CAAC,SAAS,CAAE,CAAC,CAAC,KAAK,EAAE;YAC9D,MAAM,QAAQ,GAAG,OAAO,CAAC,WAAW,CAAC,SAAU,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;YAClE,IAAI,CAAC,aAAa,CAAC,WAAW,CAC1B,QAAQ,CAAC,CAAC,EAAE,QAAQ,CAAC,CAAC,EAAE,QAAQ,CAAC,KAAK,EAAE,QAAQ,CAAC,MAAM,CAAC,CAAC;YAC7D,IAAI,CAAC,MAAM,CAAC,gBAAgB,CAAC,SAAS,CAAC,IAAI,CAAC,gBAAgB,CAAC,CAAC;YAC9D,MAAM,UAAU,GAAG,OAAO,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YAEpE,IAAI,CAAC,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;YAC1C,IAAI,CAAC,MAAM,CAAC,iBAAiB,CAAC,IAAI,CAAC,CAAC;YAEpC,mEAAmE;YACnE,8DAA8D;YAC9D,iBAAiB;YACjB,IAAI,CAAC,OAAO,CAAC,MAAM,CACf,IAAI,CAAC,eAAe,CAAE,EACtB,KAAK,EACL,IAAI,CAAC,eAAe,CAAE,EACtB,IAAI,CAAC,SAAS,CAAE,CAAC,CAAC;YACtB,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;YAE3B,wDAAwD;YACxD,gEAAgE;YAChE,mCAAmC;YACnC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,CAAC;SACpD;IACH,CAAC;CACF","sourcesContent":["/* @license\n * Copyright 2019 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {EventDispatcher, Matrix4, Object3D, PerspectiveCamera, Raycaster, Scene, Vector3, WebGLRenderer,} from 'three';\n\nimport {assertIsArCandidate} from '../utilities.js';\n\nimport {ModelScene} from './ModelScene.js';\nimport {Renderer} from './Renderer.js';\nimport Reticle from './Reticle.js';\nimport {assertContext} from './WebGLUtils.js';\n\nconst $presentedScene = Symbol('presentedScene');\n\nconst $rafId = Symbol('rafId');\nconst $currentSession = Symbol('currentSession');\nconst $tick = Symbol('tick');\nconst $refSpace = Symbol('refSpace');\nconst $viewerRefSpace = Symbol('viewerRefSpace');\nconst $resolveCleanup = Symbol('resolveCleanup');\n\nconst $outputContext = Symbol('outputContext');\n\nconst $onWebXRFrame = Symbol('onWebXRFrame');\nconst $postSessionCleanup = Symbol('postSessionCleanup');\n\nconst matrix4 = new Matrix4();\nconst vector3 = new Vector3();\n\nexport class ARRenderer extends EventDispatcher {\n  public threeRenderer: WebGLRenderer;\n  public inputContext: WebGLRenderingContext;\n\n  public camera: PerspectiveCamera = new PerspectiveCamera();\n  public scene: Scene = new Scene();\n  public dolly: Object3D = new Object3D();\n  public reticle: Reticle = new Reticle(this.camera);\n  public raycaster: Raycaster|null = null;\n\n  private[$outputContext]: WebGLRenderingContext|null = null;\n  private[$rafId]: number|null = null;\n  private[$currentSession]: XRSession|null = null;\n  private[$refSpace]: XRReferenceSpace|null = null;\n  private[$viewerRefSpace]: XRReferenceSpace|null = null;\n  private[$presentedScene]: ModelScene|null = null;\n  private[$resolveCleanup]: ((...args: any[]) => void)|null = null;\n\n  constructor(private renderer: Renderer) {\n    super();\n    this.threeRenderer = renderer.threeRenderer;\n    this.inputContext = renderer.context3D!;\n\n    this.camera.matrixAutoUpdate = false;\n\n    this.scene.add(this.reticle);\n    this.scene.add(this.dolly);\n  }\n\n  initializeRenderer() {\n    this.threeRenderer.setPixelRatio(1);\n  }\n\n  async resolveARSession(): Promise<XRSession> {\n    assertIsArCandidate();\n\n    const session: XRSession = await navigator.xr!.requestSession!(\n        'immersive-ar', {requiredFeatures: ['hit-test']});\n\n    const gl: WebGLRenderingContext =\n        assertContext(this.threeRenderer.getContext());\n\n    // `makeXRCompatible` replaced `setCompatibleXRDevice` in Chrome M73 @TODO\n    // #293, handle WebXR API changes. WARNING: this can cause a GL context\n    // loss according to the spec, though current implementations don't do so.\n    await gl.makeXRCompatible();\n    this[$outputContext] = gl;\n\n    session.updateRenderState(\n        {baseLayer: new XRWebGLLayer(session, gl, {alpha: true})});\n\n    // The render state update takes effect on the next animation frame. Wait\n    // for it so that we get a framebuffer.\n    let waitForAnimationFrame = new Promise((resolve, _reject) => {\n      session.requestAnimationFrame(() => resolve());\n    });\n    await waitForAnimationFrame;\n\n    // Redirect rendering to the WebXR offscreen framebuffer.\n    // TODO: this method should be added to three.js's exported interface.\n    (this.threeRenderer as any)\n        .setFramebuffer(session.renderState.baseLayer!.framebuffer);\n    this.threeRenderer.setSize(\n        session.renderState.baseLayer!.framebufferWidth,\n        session.renderState.baseLayer!.framebufferHeight,\n        false);\n\n    return session;\n  }\n\n  /**\n   * The currently presented scene, if any\n   */\n  get presentedScene() {\n    return this[$presentedScene];\n  }\n\n  /**\n   * Resolves to true if the renderer has detected all the necessary qualities\n   * to support presentation in AR.\n   */\n  async supportsPresentation() {\n    try {\n      assertIsArCandidate();\n      return await navigator.xr!.isSessionSupported('immersive-ar');\n    } catch (error) {\n      return false;\n    }\n  }\n\n  /**\n   * Present a scene in AR\n   */\n  async present(scene: ModelScene): Promise<void> {\n    if (this.isPresenting) {\n      console.warn('Cannot present while a model is already presenting');\n    }\n\n    scene.model.scale.set(1, 1, 1);\n\n    this[$presentedScene] = scene;\n\n    this.initializeRenderer();\n\n    this[$currentSession] = await this.resolveARSession();\n    this[$currentSession]!.addEventListener('end', () => {\n      this[$postSessionCleanup]();\n    }, {once: true});\n\n    this[$refSpace] =\n        await this[$currentSession]!.requestReferenceSpace('local');\n    this[$viewerRefSpace] =\n        await this[$currentSession]!.requestReferenceSpace('viewer');\n\n    this[$tick]();\n  }\n\n  /**\n   * If currently presenting a scene in AR, stops presentation and exits AR.\n   */\n  async stopPresenting() {\n    if (!this.isPresenting) {\n      return;\n    }\n\n    const cleanupPromise = new Promise((resolve) => {\n      this[$resolveCleanup] = resolve;\n    });\n\n    try {\n      const session = this[$currentSession]!;\n      this[$currentSession] = null;\n      session.cancelAnimationFrame(this[$rafId]!);\n\n      await session.end();\n      await cleanupPromise;\n    } catch (error) {\n      console.warn('Error while trying to end AR session');\n      console.warn(error);\n\n      this[$postSessionCleanup]();\n    }\n  }\n\n  [$postSessionCleanup]() {\n    // The offscreen WebXR framebuffer is now invalid, switch\n    // back to the default framebuffer for canvas output.\n    // TODO: this method should be added to three.js's exported interface.\n    (this.threeRenderer as any).setFramebuffer(null);\n\n    // Trigger a parent renderer update. TODO(klausw): are these all\n    // necessary and sufficient?\n    if (this[$presentedScene] != null) {\n      this.dolly.remove(this[$presentedScene]!);\n      this[$presentedScene]!.isDirty = true;\n    }\n    // The renderer's render method automatically updates\n    // the device pixel ratio, but only updates the three.js renderer\n    // size if there's a size mismatch. Reset the size to force that\n    // to refresh.\n    this.renderer.setRendererSize(1, 1);\n\n    this[$refSpace] = null;\n    this[$presentedScene] = null;\n    this.scene.environment = null;\n\n    if (this[$resolveCleanup] != null) {\n      this[$resolveCleanup]!();\n    }\n  }\n\n  /**\n   * True if a scene is currently in the process of being presented in AR\n   */\n  get isPresenting(): boolean {\n    return this[$presentedScene] != null;\n  }\n\n  get outputContext() {\n    return this[$outputContext];\n  }\n\n  async placeModel() {\n    if (this[$currentSession] == null) {\n      return;\n    }\n    // NOTE: Currently rays will be cast from the middle of the screen.\n    // Eventually we might use input coordinates for this.\n\n    // Just reuse the hit matrix that the reticle has computed.\n    if (this.reticle && this.reticle.hitMatrix) {\n      const presentedScene = this[$presentedScene]!;\n      const hitMatrix = this.reticle.hitMatrix;\n\n      this.dolly.position.setFromMatrixPosition(hitMatrix);\n\n      // Orient the dolly/model to face the camera\n      const camPosition = vector3.setFromMatrixPosition(this.camera.matrix);\n      this.dolly.lookAt(camPosition.x, this.dolly.position.y, camPosition.z);\n      this.dolly.rotateY(-presentedScene.pivot.rotation.y);\n\n      this.dolly.add(presentedScene);\n\n      this.dispatchEvent({type: 'modelmove'});\n    }\n  }\n\n  /**\n   * It appears that XRSession's `inputsourceschange` event is not implemented\n   * in Chrome Canary as of m72 for 'screen' inputs, which would be preferable\n   * since we only need an \"select\" event, rather than track a pose on every\n   * frame (like a 6DOF controller). Due to this bug, on every frame, check to\n   * see if an input exists.\n   * @see https://bugs.chromium.org/p/chromium/issues/detail?id=913703\n   * @see https://immersive-web.github.io/webxr/#xrinputsource-interface\n   */\n  processXRInput(frame: XRFrame) {\n    const {session} = frame;\n\n    // Get current input sources. For now, only 'screen' input is supported,\n    // which is only added to the session's active input sources immediately\n    // before `selectstart` and removed immediately after `selectend` event.\n    // If we have a 'screen' source here, it means the output canvas was tapped.\n    const sources = Array.from(session.inputSources)\n                        .filter(input => input.targetRayMode === 'screen');\n\n    if (sources.length === 0) {\n      return;\n    }\n\n    const pose = frame.getPose(sources[0].targetRaySpace, this[$refSpace]!);\n    if (pose) {\n      this.placeModel();\n    }\n  }\n\n  [$tick]() {\n    this[$rafId] = this[$currentSession]!.requestAnimationFrame(\n        (time, frame) => this[$onWebXRFrame](time, frame));\n  }\n\n  [$onWebXRFrame](_time: number, frame: XRFrame) {\n    const {session} = frame;\n\n    const pose = frame.getViewerPose(this[$refSpace]!);\n\n    // TODO: Notify external observers of tick\n    // TODO: Note that reticle may be \"stabilized\"\n\n    this[$tick]();\n\n    if (pose == null) {\n      return;\n    }\n\n    if (this.scene.environment !== this[$presentedScene]!.environment) {\n      this.scene.environment = this[$presentedScene]!.environment;\n    }\n\n    for (const view of frame.getViewerPose(this[$refSpace]!).views) {\n      const viewport = session.renderState.baseLayer!.getViewport(view);\n      this.threeRenderer.setViewport(\n          viewport.x, viewport.y, viewport.width, viewport.height);\n      this.camera.projectionMatrix.fromArray(view.projectionMatrix);\n      const viewMatrix = matrix4.fromArray(view.transform.inverse.matrix);\n\n      this.camera.matrix.getInverse(viewMatrix);\n      this.camera.updateMatrixWorld(true);\n\n      // NOTE: Updating input or the reticle is dependent on the camera's\n      // pose, hence updating these elements after camera update but\n      // before render.\n      this.reticle.update(\n          this[$currentSession]!,\n          frame,\n          this[$viewerRefSpace]!,\n          this[$refSpace]!);\n      this.processXRInput(frame);\n\n      // NOTE: Clearing depth caused issues on Samsung devices\n      // @see https://github.com/googlecodelabs/ar-with-webxr/issues/8\n      // this.threeRenderer.clearDepth();\n      this.threeRenderer.render(this.scene, this.camera);\n    }\n  }\n}\n"]}